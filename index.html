<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Form</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.5rem;
        }

        .address-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background-color: #f8f9fa;
        }

        .address-section h3 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 1.2rem;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            flex: 100%;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95rem;
        }

        label .required {
            color: #dc3545;
            margin-left: 2px;
        }

        label .optional {
            color: #6c757d;
            font-weight: normal;
            font-size: 0.85rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        input[type="text"]:invalid {
            border-color: #dc3545;
        }

        .input-container {
            position: relative;
        }

        .custom-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .error-message {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .loading-message {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            text-align: center;
        }

        .checking-message {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .container {
                padding: 20px 15px;
                margin: 10px;
            }

            .address-section {
                padding: 20px 15px;
            }

            h2 {
                font-size: 1.3rem;
            }

            .address-section h3 {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                margin: 5px;
                padding: 15px 10px;
            }

            .address-section {
                padding: 15px 10px;
                margin-bottom: 25px;
            }

            input[type="text"] {
                padding: 14px 12px;
                font-size: 16px;
            }

            button {
                padding: 16px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Enter Addresses</h2>
        <form id="addressForm">
            <!-- Pickup Address Section -->
            <div class="address-section">
                <h3>Pickup Address</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupLine1">Address Line 1 <span class="required">*</span></label>
                        <input type="text" id="pickupLine1" name="pickupLine1" required placeholder="House/Flat No, Building">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupLine2">Address Line 2 <span class="optional">(Optional)</span></label>
                        <input type="text" id="pickupLine2" name="pickupLine2" placeholder="Street, Area">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupLandmark">Landmark <span class="optional">(Optional)</span></label>
                        <input type="text" id="pickupLandmark" name="pickupLandmark" placeholder="Near landmark">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupCity">City <span class="required">*</span></label>
                        <div class="input-container">
                            <input type="text" id="pickupCity" name="pickupCity" required placeholder="Enter city">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pickupPincode">Pincode <span class="required">*</span></label>
                        <div class="input-container">
                            <input type="text" id="pickupPincode" name="pickupPincode" required placeholder="Enter pincode" pattern="[0-9]{6}" maxlength="6">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupState">State <span class="required">*</span></label>
                        <input type="text" id="pickupState" name="pickupState" required placeholder="Enter state">
                    </div>
                </div>
            </div>

            <!-- Delivery Address Section -->
            <div class="address-section">
                <h3>Delivery Address</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryLine1">Address Line 1 <span class="required">*</span></label>
                        <input type="text" id="deliveryLine1" name="deliveryLine1" required placeholder="House/Flat No, Building">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryLine2">Address Line 2 <span class="optional">(Optional)</span></label>
                        <input type="text" id="deliveryLine2" name="deliveryLine2" placeholder="Street, Area">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryLandmark">Landmark <span class="optional">(Optional)</span></label>
                        <input type="text" id="deliveryLandmark" name="deliveryLandmark" placeholder="Near landmark">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryCity">City <span class="required">*</span></label>
                        <div class="input-container">
                            <input type="text" id="deliveryCity" name="deliveryCity" required placeholder="Enter city">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deliveryPincode">Pincode <span class="required">*</span></label>
                        <div class="input-container">
                            <input type="text" id="deliveryPincode" name="deliveryPincode" required placeholder="Enter pincode" pattern="[0-9]{6}" maxlength="6">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryState">State <span class="required">*</span></label>
                        <input type="text" id="deliveryState" name="deliveryState" required placeholder="Enter state">
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn">Check Serviceability & Submit</button>
        </form>

        <div class="loading-message" id="loadingMessage">
            Loading Google Maps...
        </div>

        <div class="checking-message" id="checkingMessage">
            Checking serviceability...
        </div>

        <div class="success-message" id="successMessage">
            Service is available! Redirecting to WhatsApp...
        </div>

        <div class="error-message" id="errorMessage">
        </div>
    </div>

    <script>
        let placesService;
        let geocoder;
        let customDropdowns = {};

        // Initialize Google Maps Services
        function initAutocomplete() {
            placesService = new google.maps.places.AutocompleteService();
            geocoder = new google.maps.Geocoder();

            // Set up autocomplete for city fields
            setupCityAutocomplete('pickupCity', 'pickupPincode', 'pickupState');
            setupCityAutocomplete('deliveryCity', 'deliveryPincode', 'deliveryState');

            // Set up pincode validation and auto-fill
            setupPincodeAutocomplete('pickupPincode', 'pickupCity', 'pickupState');
            setupPincodeAutocomplete('deliveryPincode', 'deliveryCity', 'deliveryState');

            // Hide loading message
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Setup city autocomplete with state auto-fill
        function setupCityAutocomplete(cityFieldId, pincodeFieldId, stateFieldId) {
            const cityInput = document.getElementById(cityFieldId);
            const pincodeInput = document.getElementById(pincodeFieldId);
            const stateInput = document.getElementById(stateFieldId);
            const container = cityInput.parentElement;
            let debounceTimer;

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'custom-autocomplete-dropdown';
            container.appendChild(dropdown);
            customDropdowns[cityFieldId] = dropdown;

            cityInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearTimeout(debounceTimer);

                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    searchCities(query, dropdown, cityInput, stateInput);
                }, 500);
            });

            // Handle dropdown interactions
            setupDropdownInteractions(cityInput, dropdown);
        }

        // Setup pincode autocomplete with city and state auto-fill
        function setupPincodeAutocomplete(pincodeFieldId, cityFieldId, stateFieldId) {
            const pincodeInput = document.getElementById(pincodeFieldId);
            const cityInput = document.getElementById(cityFieldId);
            const stateInput = document.getElementById(stateFieldId);
            const container = pincodeInput.parentElement;
            let debounceTimer;

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'custom-autocomplete-dropdown';
            container.appendChild(dropdown);
            customDropdowns[pincodeFieldId] = dropdown;

            pincodeInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearTimeout(debounceTimer);

                // Only allow numeric input
                e.target.value = query.replace(/[^0-9]/g, '');

                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    if (query.length >= 3) {
                        searchPincodes(query, dropdown, pincodeInput, cityInput, stateInput);
                    }
                }, 500);
            });

            // Handle dropdown interactions
            setupDropdownInteractions(pincodeInput, dropdown);
        }

        // Common dropdown interaction setup
        function setupDropdownInteractions(inputElement, dropdown) {
            document.addEventListener('click', (e) => {
                if (!inputElement.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            inputElement.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!dropdown.matches(':hover')) {
                        dropdown.style.display = 'none';
                    }
                }, 200);
            });

            inputElement.addEventListener('focus', () => {
                if (dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });
        }

        // Search cities using Google Places API
        function searchCities(query, dropdown, cityInput, stateInput) {
            const request = {
                input: query,
                types: ['(cities)'],
                componentRestrictions: { country: 'IN' }
            };

            placesService.getPlacePredictions(request, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    displayCityPredictions(predictions.slice(0, 5), dropdown, cityInput, stateInput);
                } else {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Search pincodes using Geocoding API
        function searchPincodes(query, dropdown, pincodeInput, cityInput, stateInput) {
            geocoder.geocode({
                address: query,
                componentRestrictions: { country: 'IN', postalCode: query }
            }, (results, status) => {
                if (status === 'OK' && results.length > 0) {
                    displayPincodePredictions(results.slice(0, 5), dropdown, pincodeInput, cityInput, stateInput);
                } else {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Display city predictions
        function displayCityPredictions(predictions, dropdown, cityInput, stateInput) {
            dropdown.innerHTML = '';

            predictions.forEach(prediction => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';

                const mainText = prediction.structured_formatting.main_text;
                const secondaryText = prediction.structured_formatting.secondary_text;

                item.innerHTML = `
                    <div style="font-weight: bold; color: #333;">${mainText}</div>
                    <div style="color: #666; font-size: 12px;">${secondaryText || ''}</div>
                `;

                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    cityInput.value = mainText;
                    dropdown.style.display = 'none';

                    // Extract and set state
                    if (secondaryText) {
                        const stateName = extractStateName(secondaryText);
                        if (stateName) {
                            stateInput.value = stateName;
                        }
                    }
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        // Display pincode predictions
        function displayPincodePredictions(results, dropdown, pincodeInput, cityInput, stateInput) {
            dropdown.innerHTML = '';

            results.forEach(result => {
                const addressComponents = result.address_components;
                const pincode = extractComponent(addressComponents, 'postal_code');
                const city = extractComponent(addressComponents, 'locality') || 
                           extractComponent(addressComponents, 'administrative_area_level_2');
                const state = extractComponent(addressComponents, 'administrative_area_level_1');

                if (pincode) {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';

                    item.innerHTML = `
                        <div style="font-weight: bold; color: #333;">${pincode}</div>
                        <div style="color: #666; font-size: 12px;">${city}, ${state}</div>
                    `;

                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        pincodeInput.value = pincode;
                        if (city) cityInput.value = city;
                        if (state) stateInput.value = state;
                        dropdown.style.display = 'none';
                    });

                    dropdown.appendChild(item);
                }
            });

            dropdown.style.display = 'block';
        }

        // Extract address component by type
        function extractComponent(components, type) {
            const component = components.find(comp => comp.types.includes(type));
            return component ? component.long_name : null;
        }

        // Extract state name from secondary text
        function extractStateName(secondaryText) {
            const parts = secondaryText.split(',');
            return parts.length > 0 ? parts[parts.length - 1].trim() : null;
        }

        // Check serviceability using the API
        async function checkServiceability(pickupPincode, deliveryPincode) {
            try {
                const response = await fetch('https://sandbox-apis.prayog.io/serviceability/v1/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_postal_code: pickupPincode,
                        destination_postal_code: deliveryPincode
                    })
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error checking serviceability:', error);
                return {
                    success: false,
                    error: 'Failed to check serviceability. Please try again.'
                };
            }
        }

        // Show/hide messages
        function showMessage(elementId, message) {
            hideAllMessages();
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.style.display = 'block';
        }

        function hideAllMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('checkingMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Handle Google Maps API load error
        function handleGoogleMapsError() {
            showMessage('errorMessage', 'Error loading Google Maps. Please check your API key.');
        }

        // Show loading message initially
        document.getElementById('loadingMessage').style.display = 'block';

        // Form submission handling
        const form = document.getElementById('addressForm');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();

            // Get all form values
            const pickupData = {
                line1: document.getElementById('pickupLine1').value.trim(),
                line2: document.getElementById('pickupLine2').value.trim(),
                landmark: document.getElementById('pickupLandmark').value.trim(),
                city: document.getElementById('pickupCity').value.trim(),
                pincode: document.getElementById('pickupPincode').value.trim(),
                state: document.getElementById('pickupState').value.trim()
            };

            const deliveryData = {
                line1: document.getElementById('deliveryLine1').value.trim(),
                line2: document.getElementById('deliveryLine2').value.trim(),
                landmark: document.getElementById('deliveryLandmark').value.trim(),
                city: document.getElementById('deliveryCity').value.trim(),
                pincode: document.getElementById('deliveryPincode').value.trim(),
                state: document.getElementById('deliveryState').value.trim()
            };

            // Validate required fields
            const requiredFields = [
                { value: pickupData.line1, name: 'Pickup Address Line 1' },
                { value: pickupData.city, name: 'Pickup City' },
                { value: pickupData.pincode, name: 'Pickup Pincode' },
                { value: pickupData.state, name: 'Pickup State' },
                { value: deliveryData.line1, name: 'Delivery Address Line 1' },
                { value: deliveryData.city, name: 'Delivery City' },
                { value: deliveryData.pincode, name: 'Delivery Pincode' },
                { value: deliveryData.state, name: 'Delivery State' }
            ];

            const emptyFields = requiredFields.filter(field => !field.value);
            if (emptyFields.length > 0) {
                showMessage('errorMessage', `Please fill in: ${emptyFields.map(f => f.name).join(', ')}`);
                return;
            }

            // Validate pincode format
            const pincodePattern = /^[0-9]{6}$/;
            if (!pincodePattern.test(pickupData.pincode)) {
                showMessage('errorMessage', 'Pickup pincode must be 6 digits');
                return;
            }
            if (!pincodePattern.test(deliveryData.pincode)) {
                showMessage('errorMessage', 'Delivery pincode must be 6 digits');
                return;
            }

            // Disable submit button and show checking message
            submitBtn.disabled = true;
            showMessage('checkingMessage', 'Checking serviceability...');

            try {
                // Check serviceability
                const serviceabilityResult = await checkServiceability(pickupData.pincode, deliveryData.pincode);

                console.log('Serviceability Result:', serviceabilityResult);

                if (serviceabilityResult.success && serviceabilityResult.is_serviceable) {
                    // Service is available
                    showMessage('successMessage', 'Service is available! Redirecting to WhatsApp...');

                    setTimeout(() => {
                        const phoneNumber = '916358250345';

                        // Format addresses for WhatsApp
                        const pickupAddress = formatAddressForWhatsApp(pickupData, 'Pickup Address');
                        const deliveryAddress = formatAddressForWhatsApp(deliveryData, 'Delivery Address');

                        const message = encodeURIComponent(`${pickupAddress}\n\n${deliveryAddress}`);
                        const whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${message}`;
                        window.location.href = whatsappURL;
                    }, 1500);

                } else if (serviceabilityResult.success && !serviceabilityResult.is_serviceable) {
                    // Service not available
                    const errorDetails = serviceabilityResult.data;
                    let errorMessage = 'Sorry, we do not provide service between these locations.';

                    if (errorDetails && errorDetails.message) {
                        errorMessage = errorDetails.message;
                    }

                    showMessage('errorMessage', errorMessage);

                } else {
                    // API error or unexpected response
                    const errorMsg = serviceabilityResult.error || 'Unable to check serviceability. Please try again.';
                    showMessage('errorMessage', errorMsg);
                }

            } catch (error) {
                console.error('Error during serviceability check:', error);
                showMessage('errorMessage', 'Error checking serviceability. Please try again.');
            }

            // Re-enable submit button
            submitBtn.disabled = false;
        });

        // Format address data for WhatsApp message
        function formatAddressForWhatsApp(addressData, title) {
            let formatted = `${title}:\n`;
            formatted += `zip: ${addressData.pincode}\n`;
            
            // Combine street address (line1 + line2 + landmark)
            let street = addressData.line1;
            if (addressData.line2) {
                street += `, ${addressData.line2}`;
            }
            if (addressData.landmark) {
                street += `, ${addressData.landmark}`;
            }
            formatted += `street: ${street}\n`;
            
            formatted += `city: ${addressData.city}\n`;
            formatted += `state: ${addressData.state}`;
            return formatted;
        }

        // Prevent zoom on iOS when focusing inputs
        const inputs = document.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            input.addEventListener('focus', function () {
                if (window.innerWidth < 768) {
                    document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }
            });

            input.addEventListener('blur', function () {
                document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0');
            });
        });
    </script>

    <!-- Load Google Maps Places API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAUDgijpqock4xtLQrgOHIkPAdQF8FqaF8&libraries=places&callback=initAutocomplete&loading=async"
        onerror="handleGoogleMapsError()"></script>
</body>

</html>
